<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Game Commands</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .flash-update {
            animation: flash-animation 0.5s 1;
        }

        @keyframes flash-animation {
            0% {
                background-color: rgba(var(--bs-info-rgb), 0.3);
            }

            100% {
                background-color: transparent;
            }
        }
    </style>

</head>
<body class="bg-dark text-light">
    <div class="container">
        <div class="container text-center">
            <div class="row">
                <div class="col bg-info bg-opacity-10 border border-primary">
                    <h1 class="--bs-primary mt-3 mb-3">SkInterface</h1>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <h5 id="connectionStatus" class="text-warning">Checking server connection...</h5>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <!-- Button to toggle the collapsible -->
                <button class="btn btn-success mb-2" type="button" data-bs-toggle="collapse"
                        data-bs-target="#gameVariablesCollapse" aria-expanded="false"
                        aria-controls="gameVariablesCollapse" id="toggleGameVariablesBtn"
                        style="display: none;">
                    View Game Variables
                </button>
            </div>
            <div class="col col-sm-3 d-flex align-items-center">
                <div class="form-check" id="flashCheck">
                    <input class="form-check-input" type="checkbox" value="" id="flashCheckbox" checked>
                    <label class="form-check-label" for="flashCheckbox">
                        Flash on Update
                    </label>
                </div>
            </div>
            <div class="col col-sm-3 d-flex align-items-center">
                <input type="number" id="columnControlInput" class="form-control" value="1" min="1" max="6">
            </div>

        </div>
        <!-- Collapsible container for game variables -->
        <div class="collapse" id="gameVariablesCollapse">
            <div id="gameVariables" class="p-3 bg-info bg-opacity-10 border border-info rounded"></div>
        </div>
        <div id="commands"></div>
    </div>

    <!-- Response Modal -->
    <div class="modal modal-dialog-scrollable" id="responseModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Command Response</h5>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        window.onload = function () {
            const commandsContainer = document.getElementById('commands');
            const loadingSpinner = document.createElement('div');
            loadingSpinner.innerHTML = `<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>`;
            commandsContainer.appendChild(loadingSpinner);

            fetch('/commands')
                .then(response => {

                    const loadingSpinner = document.querySelector('.spinner-border'); // Assuming you have a class to identify the spinner
                    if (loadingSpinner) {
                        loadingSpinner.parentElement.removeChild(loadingSpinner);
                    }

                    return response.json();
                })
                .then(data => {
                    createCommandButtons(data.commands);

                    // Set header
                    if (data.productName) {
                        const headerElement = document.querySelector('h1');
                        //headerElement.textContent += ` - ${data.productName}`;
                        headerElement.textContent = `SkInterface â–º ${data.productName}`;
                    }


                });
        };

        function executeCommand(command) {
            fetch(command)
                .then(response => response.text())
                .then(data => displayResponse(data));
        }

        function showModalForCommand(command, parameters) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = ''; // Clear previous contents

            parameters.forEach(param => {
                if (param.Name === 'response') {
                    return; // Skip this iteration, don't create input for 'response'
                }
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group mb-3';

                const inputLabel = document.createElement('label');
                inputLabel.textContent = param.Name + ': ';
                inputLabel.className = 'input-group-text';

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.placeholder = param.Name;
                input.id = 'input-' + param.Name; // Ensure unique ID for each input
                input.setAttribute('data-parameter', param.Name); // Use parameter name

                inputGroup.appendChild(inputLabel);
                inputGroup.appendChild(input);
                modalBody.appendChild(inputGroup);
            });

            // Add a submit button to the modal
            const submitButton = document.createElement('button');
            submitButton.className = 'btn btn-block btn-primary';
            submitButton.textContent = 'Submit';
            submitButton.onclick = () => {
                const inputs = modalBody.querySelectorAll('input');
                const inputValues = Array.from(inputs).reduce((acc, input) => {
                    // Use the parameter name stored in 'data-parameter' for each input
                    const paramName = input.getAttribute('data-parameter');
                    acc[paramName] = input.value;
                    return acc;
                }, {});

                // Close modal and send parameters correctly
                const modalElement = document.getElementById('responseModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                modalInstance.hide();

                sendCommandWithParameters(command, inputValues);
            };
            modalBody.appendChild(submitButton);

            // Show modal using Bootstrap 5's JavaScript API
            const modalElement = document.getElementById('responseModal');
            const modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
        }

        function sendCommandWithParameters(command, parameters) {
            // Construct a query string where keys are parameter names
            const queryString = Object.entries(parameters).map(([key, value]) =>
                `${encodeURIComponent(key)}=${encodeURIComponent(value)}`
            ).join('&');

            fetch(`${command}?${queryString}`)
                .then(response => response.text())
                .then(data => displayResponse(data));
        }


        function displayResponse(data) {
            // Set the response data to the modal's body
            document.getElementById('modalBody').textContent = data;

            // Show the modal using Bootstrap 5's API
            var modalElement = document.getElementById('responseModal');
            var modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
        }

        let errorLogged = false;
        let serverAvailable = true;
        let prevGameVariables = {};

        function fetchGameVariables() {
            if (!serverAvailable) {
                // Attempt to fetch only if the previous flag indicates the server might be available
                return;
            }

            fetch('/game-variables')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    updateConnectionStatus(true); // Server responded, update status to active
                    serverAvailable = true; // Server responded, mark as available
                    errorLogged = false; // Reset error flag on successful fetch
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('gameVariables');
                    const flashEnabled = document.getElementById('flashCheckbox').checked;
                    const numberOfColumns = parseInt(document.getElementById('columnControlInput').value) || 1; // Default to 1 column
                    container.innerHTML = '';

                    if (Object.keys(data).length > 0) {
                        const row = document.createElement('div');
                        row.className = 'row';

                        // Create columns
                        Object.entries(data).sort((a, b) => a[0].localeCompare(b[0]))
                            .forEach(([variableName, value], index) => {
                                const col = document.createElement('div');
                                col.className = `col-${12 / numberOfColumns}`; // Bootstrap class for column sizing

                                const card = document.createElement('div');
                                card.setAttribute('data-variable', variableName);
                                card.className = 'card';
                                const cardBody = document.createElement('div');
                                cardBody.className = 'card-body';
                                cardBody.textContent = `${variableName}: ${value}`;
                                card.appendChild(cardBody);

                                col.appendChild(card);
                                row.appendChild(col);

                                // Ensure new row for every 'numberOfColumns' variables
                                if ((index + 1) % numberOfColumns === 0) {
                                    container.appendChild(row.cloneNode(true)); // Add the current row to the container
                                    row.innerHTML = ''; // Clear the row for the next set of columns
                                }
                            });

                        Object.entries(data).forEach(([variableName, value]) => {
                            // Check if the variable's value has changed
                            if (prevGameVariables[variableName] !== value) {
                                const variableElement = document.querySelector(`[data-variable="${variableName}"]`);
                                if (variableElement && flashEnabled) {
                                    variableElement.classList.add('flash-update');

                                    // Remove the class after animation ends
                                    setTimeout(() => {
                                        variableElement.classList.remove('flash-update');
                                    }, 1000);
                                }
                            }
                        });

                        prevGameVariables = { ...data };

                        // Add any remaining columns not appended in the forEach loop
                        if (row.hasChildNodes()) {
                            container.appendChild(row);
                        }

                        document.getElementById('toggleGameVariablesBtn').style.display = 'block';
                        document.getElementById('columnControlInput').style.display = 'block';
                        document.getElementById('flashCheck').style.display = 'block';
                    } else {
                        document.getElementById('toggleGameVariablesBtn').style.display = 'none';
                        document.getElementById('columnControlInput').style.display = 'none';
                        document.getElementById('flashCheck').style.display = 'none';
                    }
                })
                .catch(error => {
                    serverAvailable = false; // Assume server might be down
                    updateConnectionStatus(false); // Failed to fetch, update status to inactive
                    if (!errorLogged) {
                        console.error('Failed to fetch game variables:', error);
                        document.getElementById('toggleGameVariablesBtn').style.display = 'none';
                        document.getElementById('columnControlInput').style.display = 'none';
                        document.getElementById('gameVariables').innerHTML = '';
                        document.getElementById('gameVariables').style.display = 'none';
                        document.getElementById('flashCheck').style.display = 'none';
                        errorLogged = true; // Log the error once
                    }
                    // Implement a retry logic after a delay
                    setTimeout(fetchGameVariables, 5000); // Retry after 5 seconds
                });
        }

        // Poll game variables
        fetchGameVariables();
        setInterval(fetchGameVariables, 2000);

        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = "Telemetry Active";
                statusElement.className = "text-success"; // Use Bootstrap class for styling
            }
            else {
                statusElement.textContent = ""//"Telemetry Lost";
                statusElement.className = "text-danger"; // Use Bootstrap class for styling
            }
        }

        function titleize(str) {
            // Insert a space before capital letters found in the middle of a word
            const withSpaces = str.replace(/([a-z])([A-Z])/g, '$1 $2');

            // Convert string to lowercase, then titleize
            return withSpaces.toLowerCase().split(' ').map(function (word) {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }

        function createCommandButtons(commandsData) {
            const commandsContainer = document.getElementById('commands');
            commandsContainer.innerHTML = ''; // Clear previous commands

            // Group commands by category and sort categories
            const groupedCommands = commandsData.reduce((acc, cmd) => {
                const category = cmd.Category || 'Miscellaneous';
                acc[category] = acc[category] || [];
                acc[category].push(cmd);
                return acc;
            }, {});

            // Ensure "Miscellaneous" category is sorted to the bottom
            const sortedCategories = Object.keys(groupedCommands).sort((a, b) => {
                if (a === "Miscellaneous") return 1;
                if (b === "Miscellaneous") return -1;
                return a.localeCompare(b); // Alphabetical sort for the rest
            });

            // Create sections for each category
            sortedCategories.forEach(category => {
                const cmds = groupedCommands[category].sort((a, b) => a.Path.localeCompare(b.Path)); // Sort commands within category

                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category-section mt-4 mb-3`;

                const categoryHeader = document.createElement('h4');
                categoryHeader.textContent = category;
                categoryHeader.className = 'text-warning mb-3';
                categoryDiv.appendChild(categoryHeader);

                const row = document.createElement('div');
                row.className = 'row row-cols-1 row-cols-md-3 g-4 border';

                cmds.forEach(cmd => {
                    const col = document.createElement('div');
                    col.className = 'col d-flex';

                    const button = document.createElement('button');
                    const titleizedCmd = titleize(cmd.Path.substring(1)); // Adjusted for the updated data structure
                    button.textContent = titleizedCmd;
                    button.className = 'btn btn-primary mb-2 flex-grow-1';

                    var cmdParLength = cmd.Parameters.length;
                    if (cmd.Parameters.some(param => param.Name !== 'response')) {
                        button.onclick = () => showModalForCommand(cmd.Path, cmd.Parameters);
                    } else {
                        button.onclick = () => executeCommand(cmd.Path);
                    }
                    col.appendChild(button);
                    row.appendChild(col);
                });

                categoryDiv.appendChild(row);
                commandsContainer.appendChild(categoryDiv);
            });
        }

        document.getElementById('columnControlInput').addEventListener('change', fetchGameVariables);
    </script>
</body>
</html>
