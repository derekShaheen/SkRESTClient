<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Unity WickerREST</title>
    <!-- Google Fonts Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        .flash-update {
            animation: flash-animation 0.75s 1;
        }

        @keyframes flash-animation {
            0% {
                background-color: rgba(var(--bs-info-rgb), 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        /* Apply Oswald Font to All Headers */
        h1, h2, h3, h4, h5, h6 {
            font-family: "Ubuntu", sans-serif;
            font-weight: 700;
        }
    </style>

</head>
<body class="bg-dark text-light">
    <div class="container mt-2">
        <div class="container">
            <div class="row bg-info bg-opacity-10 border border-primary text-center">
                <div class="col-1 mt-1">
                    <a href="#" onclick="window.location.reload(true);">
                        <img src="https://raw.githubusercontent.com/derekShaheen/SkRESTClient/main/web/resources/h512.png" class="img-thumbnail" style="min-width: 45px; min-height: 45px;">
                    </a>
                </div>
                <div class="col mt-1">
                    <h5 class="--bs-secondary-color">Unity WickerREST</h5>
                    <h1 class="--bs-primary"></h1>
                </div>
            </div>
            <div class="row mt-2 mb-2">
                <div class="col d-flex">
                    <!-- Button to toggle the collapsible -->
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse"
                            data-bs-target="#gameVariablesCollapse" aria-expanded="false"
                            aria-controls="gameVariablesCollapse" id="toggleGameVariablesBtn"
                            style="display: none;">
                        View Game Variables
                    </button>
                </div>
                <div class="col d-flex align-items-center">
                    <h5 id="connectionStatus" class="text-warning">Checking server connection...</h5>
                </div>
                <div class="col col-sm-3 d-flex align-items-center">
                    <div class="form-check" id="flashCheck">
                        <input class="form-check-input" type="checkbox" value="" id="flashCheckbox" checked>
                        <label class="form-check-label" for="flashCheckbox">
                            Flash on Update
                        </label>
                    </div>
                </div>
                <div class="col col-sm-3 d-flex align-items-center">
                    <input type="number" id="columnControlInput" class="form-control" value="2" min="1" max="6">
                </div>
            </div>
            <div class="row mt-2 mb-2">
                <!-- Collapsible container for game variables -->
                <div class="collapse" id="gameVariablesCollapse">
                    <div id="gameVariables" class="p-3 bg-info bg-opacity-10 border border-info rounded"></div>
                </div>
                <div id="commands"></div>
                <div class="console-container mt-2">
                    <h4 class="text-warning">Command Output</h4>
                    <div id="commandOutput" class="console-output p-1 bg-dark text-white border" style="height: 200px; overflow-y: scroll;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Response Modal -->
    <div class="modal modal-dialog-scrollable" id="responseModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Command Response</h5>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        window.onload = function () {
            // Handle Cookies
            const columnControlInput = document.getElementById('columnControlInput');
            const cookies = document.cookie.split(';').reduce((res, c) => {
                const [key, val] = c.trim().split('=').map(decodeURIComponent);
                try {
                    return Object.assign(res, { [key]: JSON.parse(val) });
                } catch (e) {
                    return Object.assign(res, { [key]: val });
                }
            }, {});

            // Check if the columnCount cookie exists and set the input value
            if (cookies.columnCount) {
                columnControlInput.value = cookies.columnCount;
            }

            // Fetch commands
            const commandsContainer = document.getElementById('commands');
            const loadingSpinner = document.createElement('div');
            loadingSpinner.innerHTML = `<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>`;
            commandsContainer.appendChild(loadingSpinner);

            fetch('/commands')
                .then(response => {

                    return response.json();
                })
                .then(data => {
                    const loadingSpinner = document.querySelector('.spinner-border'); // Assuming you have a class to identify the spinner
                    if (loadingSpinner) {
                        loadingSpinner.parentElement.removeChild(loadingSpinner);
                    }

                    createCommandButtons(data.commands);

                    // Set header
                    if (data.productName) {
                        const headerElement = document.querySelector('h1');
                        //headerElement.textContent += ` - ${data.productName}`;
                        headerElement.textContent = `${data.productName}`;
                    }


                });
        };

        function executeCommand(command) {
            fetch(command)
                .then(response => response.text())
                .then(data => displayResponse(command, command, data));
        }

        function showModalForCommand(command, parameters) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = ''; // Clear previous contents

            parameters.forEach(param => {
                if (param.Name === 'response') {
                    return; // Skip 'response' parameter
                }
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group mb-3';

                const inputLabel = document.createElement('label');
                inputLabel.textContent = param.Name + ': ';
                inputLabel.className = 'input-group-text';

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.placeholder = param.Name;
                input.id = 'input-' + param.Name;
                input.setAttribute('data-parameter', param.Name);

                // Set default value if available
                if (param.DefaultValue !== null) {
                    input.value = param.DefaultValue;
                }

                inputGroup.appendChild(inputLabel);
                inputGroup.appendChild(input);
                modalBody.appendChild(inputGroup);
            });

            // Add a submit button to the modal
            const submitButton = document.createElement('button');
            submitButton.className = 'btn btn-block btn-primary';
            submitButton.textContent = 'Submit';
            submitButton.onclick = () => {
                const inputs = modalBody.querySelectorAll('input');
                const inputValues = Array.from(inputs).reduce((acc, input) => {
                    const paramName = input.getAttribute('data-parameter');
                    acc[paramName] = input.value;
                    return acc;
                }, {});

                const modalElement = document.getElementById('responseModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                modalInstance.hide();

                sendCommandWithParameters(command, inputValues);
            };
            modalBody.appendChild(submitButton);

            const modalElement = document.getElementById('responseModal');
            const modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
        }


        function sendCommandWithParameters(command, parameters) {
            // Construct a query string where keys are parameter names
            const queryString = Object.entries(parameters).map(([key, value]) =>
                `${encodeURIComponent(key)}=${encodeURIComponent(value)}`
            ).join('&');

            var commandStr = `${command}?${queryString}`;

            fetch(`${commandStr}`)
                .then(response => response.text())
                .then(data => displayResponse(command, commandStr, data));
        }

        function displayResponse(command, commandStr, data) {
            const commandOutput = document.getElementById('commandOutput');

            // Format the current timestamp
            const timestamp = new Date().toLocaleTimeString();

            // Create a new div element for the response
            const responseContainer = document.createElement('div');
            responseContainer.classList.add('command-response');

            // Create a clickable link element
            const commandLink = document.createElement('a');
            commandLink.href = commandStr; // Using '#' for now; this will be handled by JavaScript
            commandLink.textContent = `[${timestamp}] ${command.substring(1)} → ${data || 'Command executed.'}`;
            commandLink.classList.add('command-link');
            commandLink.style.color = 'inherit'; // Use the same color as the parent element
            commandLink.style.textDecoration = 'none'; // Remove underline
            commandLink.onclick = function (e) {
                e.preventDefault(); // Prevent the default anchor action
                executeCommandAgain(commandStr); // Function to execute the command again
            };

            // Append the link to the response container
            responseContainer.appendChild(commandLink);

            // Append the new div to the command output container
            //commandOutput.appendChild(responseContainer);
            commandOutput.insertBefore(responseContainer, commandOutput.firstChild);

            // Scroll to the bottom of the command output container
            commandOutput.scrollTop = 0;
        }

        // Function to re-execute a command from a click
        function executeCommandAgain(commandWithParameters) {
            // Extract the command and parameters from the commandWithParameters string
            // This might need to be adjusted based on how the command string is formatted
            const [command, queryString] = commandWithParameters.split('?');

            // Re-fetch the command with its parameters
            fetch(commandWithParameters)
                .then(response => response.text())
                .then(data => displayResponse(command, commandWithParameters, data));
        }

        let errorLogged = false;
        let serverAvailable = true;
        let prevGameVariables = {};

        function fetchGameVariables() {
            if (!serverAvailable) {
                // Attempt to fetch only if the previous flag indicates the server might be available
                return;
            }

            fetch('/game-variables')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    updateConnectionStatus(true); // Server responded, update status to active
                    serverAvailable = true; // Server responded, mark as available
                    errorLogged = false; // Reset error flag on successful fetch
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('gameVariables');
                    const flashEnabled = document.getElementById('flashCheckbox').checked;
                    const numberOfColumns = parseInt(document.getElementById('columnControlInput').value) || 1; // Default to 1 column
                    container.innerHTML = '';

                    if (Object.keys(data).length > 0) {
                        const row = document.createElement('div');
                        row.className = 'row';

                        // Create columns
                        Object.entries(data).sort((a, b) => a[0].localeCompare(b[0]))
                            .forEach(([variableName, value], index) => {
                                const col = document.createElement('div');
                                col.className = `col-${12 / numberOfColumns}`; // Bootstrap class for column sizing

                                const card = document.createElement('div');
                                card.setAttribute('data-variable', variableName);
                                card.className = 'card mt-2';
                                const cardBody = document.createElement('div');
                                cardBody.className = 'card-body';
                                const titleizedCard = titleize(variableName);
                                cardBody.textContent = `${titleizedCard}: ${value}`;
                                card.appendChild(cardBody);

                                col.appendChild(card);
                                row.appendChild(col);

                                // Ensure new row for every 'numberOfColumns' variables
                                if ((index + 1) % numberOfColumns === 0) {
                                    container.appendChild(row.cloneNode(true)); // Add the current row to the container
                                    row.innerHTML = ''; // Clear the row for the next set of columns
                                }
                            });

                        Object.entries(data).forEach(([variableName, value]) => {
                            // Check if the variable's value has changed
                            if (prevGameVariables[variableName] !== value) {
                                const variableElement = document.querySelector(`[data-variable="${variableName}"]`);
                                if (variableElement && flashEnabled) {
                                    variableElement.classList.add('flash-update');

                                    // Remove the class after animation ends
                                    setTimeout(() => {
                                        variableElement.classList.remove('flash-update');
                                    }, 1000);
                                }
                            }
                        });

                        prevGameVariables = { ...data };

                        // Add any remaining columns not appended in the forEach loop
                        if (row.hasChildNodes()) {
                            container.appendChild(row);
                        }

                        document.getElementById('toggleGameVariablesBtn').style.display = 'block';
                        document.getElementById('columnControlInput').style.display = 'block';
                        document.getElementById('flashCheck').style.display = 'block';
                    } else {
                        document.getElementById('toggleGameVariablesBtn').style.display = 'none';
                        document.getElementById('columnControlInput').style.display = 'none';
                        document.getElementById('flashCheck').style.display = 'none';
                    }
                })
                .catch(error => {
                    serverAvailable = false; // Assume server might be down
                    updateConnectionStatus(false); // Failed to fetch, update status to inactive
                    if (!errorLogged) {
                        console.error('Failed to fetch game variables:', error);
                        document.getElementById('toggleGameVariablesBtn').style.display = 'none';
                        document.getElementById('columnControlInput').style.display = 'none';
                        document.getElementById('gameVariables').innerHTML = '';
                        document.getElementById('gameVariables').style.display = 'none';
                        document.getElementById('flashCheck').style.display = 'none';
                        errorLogged = true; // Log the error once
                    }
                    // Implement a retry logic after a delay
                    setTimeout(fetchGameVariables, 5000); // Retry after 5 seconds
                });
        }

        // Poll game variables
        fetchGameVariables();
        setInterval(fetchGameVariables, 2000);

        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = "Telemetry Active";
                statusElement.className = "text-success"; // Use Bootstrap class for styling
            }
            else {
                statusElement.textContent = ""//"Telemetry Lost";
                statusElement.className = "text-danger"; // Use Bootstrap class for styling
            }
        }

        function titleize(str) {
            // List of minor words that shouldn't be capitalized unless they are the first or last word.
            const minorWords = ['a', 'an', 'the', 'and', 'but', 'or', 'for', 'nor', 'as', 'at'
                , 'by', 'for', 'from', 'in', 'into', 'near', 'of', 'on', 'onto', 'to', 'with'];

            // Insert a space before capital letters found in the middle of a word
            const withSpaces = str.replace(/([a-z])([A-Z])/g, '$1 $2').toLowerCase();

            // Split into words and capitalize appropriately
            const words = withSpaces.split(' ').map((word, index, array) => {
                // Always capitalize the first word and the last word
                if (index === 0 || index === array.length - 1) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }

                // If it's a minor word, keep it lowercase; otherwise, capitalize it
                if (minorWords.includes(word)) {
                    return word;
                } else {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
            });

            return words.join(' ');
        }

        function createCommandButtons(commandsData) {
            const commandsContainer = document.getElementById('commands');
            commandsContainer.innerHTML = ''; // Clear previous commands

            // Group commands by category and sort categories
            const groupedCommands = commandsData.reduce((acc, cmd) => {
                const category = cmd.Category || 'Miscellaneous';
                acc[category] = acc[category] || [];
                acc[category].push(cmd);
                return acc;
            }, {});

            // Ensure "Miscellaneous" category is sorted to the bottom
            const sortedCategories = Object.keys(groupedCommands).sort((a, b) => {
                if (a === "Miscellaneous") return 1;
                if (b === "Miscellaneous") return -1;
                return a.localeCompare(b); // Alphabetical sort for the rest
            });

            // Create sections for each category
            sortedCategories.forEach(category => {
                const cmds = groupedCommands[category].sort((a, b) => a.Path.localeCompare(b.Path)); // Sort commands within category

                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category-section mt-2`;

                const categoryHeader = document.createElement('h4');
                categoryHeader.textContent = category;
                categoryHeader.className = 'text-warning mb-3';
                categoryDiv.appendChild(categoryHeader);

                const row = document.createElement('div');
                row.className = 'row row-cols-1 row-cols-md-3 g-4 border';

                cmds.forEach(cmd => {
                    const col = document.createElement('div');
                    col.className = 'col d-flex';

                    const button = document.createElement('button');
                    const titleizedCmd = titleize(cmd.Path.substring(1)); // Adjusted for the updated data structure
                    button.textContent = titleizedCmd;
                    button.className = 'btn btn-primary mb-2 flex-grow-1';

                    var cmdParLength = cmd.Parameters.length;
                    if (cmd.Parameters.some(param => param.Name !== 'response')) {
                        button.onclick = () => showModalForCommand(cmd.Path, cmd.Parameters);
                    } else {
                        button.onclick = () => executeCommand(cmd.Path);
                    }
                    col.appendChild(button);
                    row.appendChild(col);
                });

                categoryDiv.appendChild(row);
                commandsContainer.appendChild(categoryDiv);
            });
        }

        document.getElementById('columnControlInput').addEventListener('change', function () {
            const columnCount = this.value;
            document.cookie = "SameSite=Lax; columnCount=" + columnCount + "; Path=/; max-age=31536000"; // Expires after 1 year
            fetchGameVariables();
        });

    </script>
</body>
</html>
